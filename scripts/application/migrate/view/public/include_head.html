<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Migrate</title>
<meta name="keywords" content="">
<meta name="description" content="">
<link rel="shortcut icon" href="/favicon.ico">
<link href="https://cdn.bootcss.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
<link href="/static/css/migrate/animate.min.css" rel="stylesheet">
<link href="/static/css/migrate/style.min862f.css?v=4.1.0" rel="stylesheet">
<link href="https://cdn.bootcss.com/x-editable/1.5.1/bootstrap3-editable/css/bootstrap-editable.css"
      rel="stylesheet">
<link href="https://cdn.bootcss.com/bootstrap-table/1.11.1/bootstrap-table.min.css" rel="stylesheet">
<style type="text/css">

    html, body {
        font-size: 14px;
    }

    .ms-controller {
        display: none;
    }
    
    .breadcrumb li a{
        color: #0000cc;
    }

    .breadcrumb .active {
        color: green;
    }

</style>
<!--[if lt IE 9]>
<meta http-equiv="refresh" content="0;ie.html"/>
<![endif]-->
<script src="https://cdn.bootcss.com/jquery/2.2.4/jquery.min.js"></script>
<script src="https://cdn.bootcss.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
<script src="https://cdn.bootcss.com/avalon.js/1.4.8/avalon.shim.js"></script>
<script src="https://cdn.bootcss.com/x-editable/1.5.1/bootstrap3-editable/js/bootstrap-editable.min.js"></script>
<script src="https://cdn.bootcss.com/bootstrap-table/1.11.1/bootstrap-table.min.js"></script>
<script src="/static/js/common.js"></script>
<script src="https://cdn.bootcss.com/bootstrap-table/1.11.1/locale/bootstrap-table-zh-CN.min.js"></script>
<script src="/static/lib/bootstrap-suggest/dist/bootstrap-suggest.min.js"></script>
<script src="https://cdn.bootcss.com/bootstrap-table/1.11.1/extensions/editable/bootstrap-table-editable.min.js"></script>
<script src="https://cdn.bootcss.com/moment.js/2.21.0/moment.min.js"></script>
<script src="https://cdn.bootcss.com/moment.js/2.21.0/locale/zh-cn.js"></script>
<script src="https://cdn.bootcss.com/jQuery-slimScroll/1.3.8/jquery.slimscroll.min.js"></script>
<script src="https://cdn.bootcss.com/pace/1.0.2/pace.min.js"></script>
<script src="https://cdn.bootcss.com/metisMenu/2.7.4/metisMenu.min.js"></script>
<script src="/static/js/hplus.min.js"></script>
<script src="https://cdn.bootcss.com/layer/3.1.0/layer.js"></script>
<script src="/static/js/contabs.min.js"></script>
<script type="text/javascript">
    /**
     * token值
     * @type {string}
     */
    var token = jCommon.cookieGet('token');

    /**
     * ajax完成回调函数
     * @param XMLHttpRequest
     * @param textStatus
     */
    var ajax_complete_call_back = function (XMLHttpRequest, textStatus) {
    };

    //重写ajax方法
    (function ($) {
        // 备份jquery的ajax方法
        var _ajax = $.ajax;
        // 重写ajax方法，先判断登录在执行success函数
        $.ajax = function (opt) {
            var _success = opt && opt.success || function (a, b) {
            };
            var _opt = $.extend(opt, {
                success: function (data, textStatus) {
                    if (data.status === -1) {
                        //提醒消息
                        layer.msg(data.message, function () {
                            //关闭后的操作
                        });
                    } else if (data.status === -2) {
                        //session超时
                        window.location.href = '{:url("index/index")}';
                    } else {
                        //执行原先请求
                        _success(data, textStatus);
                    }
                }
            });
            //为空情况判断
            if (jCommon.empty(_opt.data)) {
                _opt.data = {};
            }
            //自动拼接token值
            if (!_opt.data.hasOwnProperty('token') && !jCommon.empty(token)) {
                _opt.data.token = token;
            }
            //回调函数
            _opt.complete = function (XMLHttpRequest, textStatus) {
                ajax_complete_call_back(XMLHttpRequest, textStatus);
            };
            return _ajax(_opt);
        };
    })(jQuery);

    var pendingRequests = {};
    jQuery.ajaxPrefilter(function (options, originalOptions, jqXHR) {
        var key = options.url;
        console.log(key);
        if (!pendingRequests[key]) {
            pendingRequests[key] = jqXHR;
        } else {
            //jqXHR.abort(); //放弃后触发的提交
            pendingRequests[key].abort(); // 放弃先触发的提交
        }
        var complete = options.complete;
        options.complete = function (jqXHR, textStatus) {
            pendingRequests[key] = null;
            if (jQuery.isFunction(complete)) {
                complete.apply(this, arguments);
            }
        };
    });

    //设置不缓存数据
    $.ajaxSetup({
        cache: false
    });

    //校验
    if (['Index/index'].indexOf("{:request()->controller().'/'.request()->action()}") === -1) {
        if (jCommon.empty(token)) {
            //跳转至首页
            window.location.href = '{:url("index/index")}';
        }
    }

</script>